{% extends "layouts/base.html" %}
{% block title %}Credenciais Google{% endblock %}
{% block content %}
  <h2>Credenciais do Google</h2>

  <section style="margin-bottom:1.5rem;">
    <details open>
      <summary><strong>Tutorial rápido: criando um OAuth Client no Google Cloud</strong></summary>
      <ol style="margin-top:.75rem;">
        <li>Acesse o <a href="https://console.cloud.google.com/apis/credentials" target="_blank" rel="noopener">Google Cloud Console — Credentials</a>.</li>
        <li>Crie (ou selecione) um projeto.</li>
        <li>Em “OAuth consent screen”, configure o consentimento (interno, com seu email) e salve.</li>
        <li>Em “Credentials”, clique em “Create Credentials” → “OAuth client ID”.</li>
        <li>Escolha o tipo “Web application”.</li>
        <li>Adicione seus URIs autorizados (ex.: http://localhost:8080) se for usar o fluxo web (neste momento, usaremos apenas client_id, client_secret e refresh_token obtido por um fluxo isolado).</li>
        <li>Copie o client_id e client_secret e preencha abaixo.</li>
        <li>Obtenha um refresh_token para sua conta admin (pode ser via um script offline ou fluxo OAuth isolado). Preencha abaixo.</li>
      </ol>
      <p class="text-muted">
        Observação: por enquanto todo acesso às APIs do Google ocorrerá “em nome do admin”. Proteja estas credenciais.
      </p>
    </details>
  </section>

  <section>
    <form method="post" action="{{ url_for('admin_google.google_credentials_page') }}">
      {% if creds %}
        <input type="hidden" name="cred_id" value="{{ creds.id }}">
      {% endif %}

      <div class="mb-3">
        <label for="client_id" class="form-label">Client ID</label>
        <input id="client_id" name="client_id" type="text" class="form-control" required
               value="{{ creds.client_id if creds else '' }}">
      </div>

      <div class="mb-3">
        <label for="client_secret" class="form-label">Client Secret</label>
        <input id="client_secret" name="client_secret" type="password" class="form-control" required
               value="{{ creds.client_secret if creds else '' }}">
      </div>

      <div class="mb-3">
        <label for="refresh_token" class="form-label">Refresh Token</label>
        <input id="refresh_token" name="refresh_token" type="text" class="form-control"
               value="{{ creds.refresh_token if creds else '' }}">
      </div>

      <div class="mb-3">
        <label for="extra" class="form-label">Extra (JSON opcional)</label>
        <textarea id="extra" name="extra" class="form-control" rows="4" placeholder='{"scopes":["drive.readonly"]}'>{{ creds.extra | tojson if creds and creds.extra else "" }}</textarea>
      </div>

      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary">
          {% if creds %}Salvar alterações{% else %}Criar credencial{% endif %}
        </button>

        {% if creds %}
          <form method="post" action="{{ url_for('admin_google.google_credentials_export') }}" style="display:inline;">
            <input type="hidden" name="cred_id" value="{{ creds.id }}">
            <button type="submit" class="btn btn-secondary">Exportar</button>
          </form>

          <form method="post" action="{{ url_for('admin_google.google_credentials_delete') }}" style="display:inline;margin-left:.5rem;"
                onsubmit="return confirm('Tem certeza que deseja remover a credencial?');">
            <input type="hidden" name="cred_id" value="{{ creds.id }}">
            <button type="submit" class="btn btn-danger">Remover</button>
          </form>
        {% endif %}
      </div>
    </form>
  </section>
{% endblock %}